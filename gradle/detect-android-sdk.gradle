def pathExists(String envPath) {
    if (envPath != null && !envPath.empty) {
        return file(envPath).exists()
    }

    return false
}

def setPropPath(Properties props, String prop, String path) {
    if (!file(path).isDirectory()) return
    if (props.hasProperty(prop)) return
    props[prop] = path
}

def propsPath = file("../local.properties")
def props = new Properties()

if (propsPath.isFile()) {
    props.load(new FileReader(propsPath))
}

ext.hasAndroidSdk = false
String newAndroidSdkPath = null
if (props.containsKey("sdk.dir")) {
    ext.hasAndroidSdk = true
} else if (pathExists(System.env.ANDROID_HOME)) {
    newAndroidSdkPath = System.env.ANDROID_HOME
} else if (pathExists(System.env.ANDROID_SDK_ROOT)) {
    newAndroidSdkPath = System.env.ANDROID_SDK_ROOT
} else if (pathExists(System.env.HOME + "/Android/Sdk")) {
    newAndroidSdkPath = System.env.HOME + "/Android/Sdk"
}

if (newAndroidSdkPath != null) {
    setPropPath(props, "sdk.dir", newAndroidSdkPath)

    def oldProps = new Properties(props)

    if (props != oldProps) {
        def writer = new FileWriter(propsPath)
        try {
            props.store(writer, "generated by 'detect-android-sdk.gradle'")
        } finally {
            writer.close()
        }
    }

    ext.hasAndroidSdk = true
}

if (ext.hasAndroidSdk != true){
    println '''\
[WARNING] Skipping build of Android related modules because Android SDK has not been found!
          Define Android SDK location in 'local.properties' file or with ANDROID_HOME
          environment variable to build Android modules
'''
}
